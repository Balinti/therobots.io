<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Beat Breaker - Free HTML5 Game</title>
<meta name="description" content="Play Beat Breaker - Tap in rhythm to break pixel blocks before the beat speeds beyond control.">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a0a1a">
<link rel="canonical" href="https://balinti.github.io/beat-breaker/">
<meta property="og:title" content="Beat Breaker - Free HTML5 Game">
<meta property="og:description" content="Tap in rhythm to break pixel blocks before the beat speeds beyond control.">
<meta property="og:image" content="https://balinti.github.io/beat-breaker/og.png">
<meta property="og:url" content="https://balinti.github.io/beat-breaker/">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Beat Breaker - Free HTML5 Game">
<meta name="twitter:description" content="Tap in rhythm to break pixel blocks before the beat speeds beyond control.">
<meta name="twitter:image" content="https://balinti.github.io/beat-breaker/og.png">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4099346100621490" crossorigin="anonymous"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{width:100%;height:100%;overflow:hidden;background:#0a0a1a;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;color:#e0e0e0;touch-action:manipulation;-webkit-tap-highlight-color:transparent;user-select:none}
body{display:flex;flex-direction:column;align-items:center;min-height:100svh;background:linear-gradient(170deg,#0a0a1a 0%,#111130 40%,#0d0d24 100%)}
header{width:100%;max-width:420px;text-align:center;padding:8px 0 2px;flex-shrink:0}
header h1{font-size:1.1rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;background:linear-gradient(90deg,#ff6fd8,#7b68ee,#00d4ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
main{flex:1;display:flex;align-items:center;justify-content:center;width:100%;max-width:420px;position:relative}
#game-container{position:relative;width:100%;max-width:420px;aspect-ratio:420/750;max-height:750px}
canvas{display:block;width:100%;height:100%;border-radius:8px;cursor:pointer}
footer{width:100%;max-width:420px;flex-shrink:0;padding:6px 12px 10px}
.how-to{font-size:0.72rem;color:#888;line-height:1.45;text-align:center}
.how-to strong{color:#bbb}
@media(max-height:600px){header{padding:2px 0 0}footer{padding:2px 8px 4px}.how-to{font-size:0.65rem}}
</style>
</head>
<body>
<header><h1>Beat Breaker</h1></header>
<main>
<div id="game-container">
<canvas id="gc"></canvas>
</div>
</main>
<footer>
<p class="how-to"><strong>How to play:</strong> A hammer swings left and right on the beat. Tap, click, or press Space/Enter to slam the current side and break incoming blocks. Time your hits inside the ring for points. Build combos for multipliers. Don't let blocks reach the wall!</p>
</footer>
<script>
'use strict';
(()=>{
/* ── Seeded RNG for challenge mode ── */
function mulberry32(a){return()=>{a|=0;a=a+0x6D2B79F5|0;let t=Math.imul(a^a>>>15,1|a);t=t+Math.imul(t^t>>>7,61|t)^t;return((t^t>>>14)>>>0)/4294967296}}
function hashSeed(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0}return h}

/* ── Challenge seed ── */
const urlP=new URLSearchParams(location.search);
const challengeCode=urlP.get('challenge')||'';
let seededRng=challengeCode?mulberry32(hashSeed(challengeCode)):null;
function rng(){return seededRng?seededRng():Math.random()}

/* ── Canvas setup ── */
const cvs=document.getElementById('gc');
const ctx=cvs.getContext('2d');
const container=document.getElementById('game-container');
let W,H,dpr;

function resize(){
  const rect=container.getBoundingClientRect();
  dpr=Math.min(devicePixelRatio||1,2.5);
  W=420;H=750;
  cvs.width=W*dpr;cvs.height=H*dpr;
  cvs.style.width=rect.width+'px';
  cvs.style.height=rect.height+'px';
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
resize();
window.addEventListener('resize',resize);

/* ── Constants & tuning ── */
const CX=W*0.5, CY=W*0.52;
const LANE_L=W*0.28, LANE_R=W*0.72;
const RING_Y=CY;
const RING_R=34;
const WALL_OFFSET=46;
const WALL_L=LANE_L-WALL_OFFSET, WALL_R=LANE_R+WALL_OFFSET;

const BPM_START=92, BPM_MAX=132;
const SPEED_START=220, SPEED_MAX=330;
const WINDOW_START=44, WINDOW_MIN=22, WINDOW_PLATEAU_T=75;

/* ── Game state ── */
let state='start'; // start | playing | gameover
let score=0, combo=0, maxCombo=0, multiplier=1;
let bestScore=parseInt(localStorage.getItem('bb_best'))||0;
let elapsed=0, beatTimer=0, beatIndex=0;
let hammerSide=0; // 0=left, 1=right
let hammerAngle=0, hammerTargetAngle=0;
let bpm, beatInterval, approachSpeed, timingWindow;
let blocks=[], particles=[], floatingTexts=[];
let shakeX=0, shakeY=0, shakeMag=0;
let slowMoTimer=0, slowMoFactor=1;
let freezeTimer=0;
let beatPulse=0;
let lastTime=0;
let inputQueued=false;
let gameOverFlash=0;
let hueShift=0;

/* ── Block types ── */
const BT={NORMAL:0,SHIELD:1,GOLD:2,FREEZE:3};
const BT_COLORS={
  [BT.NORMAL]:'#ff6fd8',
  [BT.SHIELD]:'#7b8cff',
  [BT.GOLD]:'#ffd700',
  [BT.FREEZE]:'#00e5ff'
};

/* ── Difficulty ── */
function updateDifficulty(){
  const t=elapsed;
  const p=Math.min(t/WINDOW_PLATEAU_T,1);
  const ep=1-Math.pow(1-p,2); // ease-out quad
  bpm=BPM_START+(BPM_MAX-BPM_START)*ep;
  if(freezeTimer>0) bpm*=0.85;
  beatInterval=60/bpm;
  approachSpeed=SPEED_START+(SPEED_MAX-SPEED_START)*ep;
  timingWindow=WINDOW_START+(WINDOW_MIN-WINDOW_START)*ep;
  if(freezeTimer>0) timingWindow*=1.4;
}

/* ── Spawn logic ── */
let spawnAccum=0;
let patternQueue=[];

function pickBlockType(){
  const r=rng();
  const t=Math.min(elapsed/80,1);
  if(r<0.03+0.02*t) return BT.FREEZE;
  if(r<0.08+0.07*t) return BT.GOLD;
  if(r<0.20+0.15*t) return BT.SHIELD;
  return BT.NORMAL;
}

function spawnBlock(side){
  const type=pickBlockType();
  const lx=side===0?LANE_L:LANE_R;
  const dir=side===0?1:-1; // blocks approach from outside toward ring
  const startX=side===0?-30:W+30;
  blocks.push({
    side,type,x:startX,y:RING_Y,
    laneX:lx,dir,
    hp:type===BT.SHIELD?2:1,
    size:22,cracked:false,
    goldPulse:0
  });
}

function generateSpawns(dt){
  spawnAccum+=dt;
  const spawnInterval=beatInterval; // one potential spawn per beat
  while(spawnAccum>=spawnInterval){
    spawnAccum-=spawnInterval;
    // Pattern complexity: sometimes spawn both sides, sometimes one
    const r=rng();
    const syncoChance=Math.min(elapsed/100,0.35);
    if(r<0.15+syncoChance){
      // Both sides
      spawnBlock(0);spawnBlock(1);
    } else if(r<0.55){
      spawnBlock(0);
    } else {
      spawnBlock(1);
    }
  }
}

/* ── Particles ── */
function emitParticles(x,y,color,count,isGold){
  for(let i=0;i<count;i++){
    const ang=rng()*Math.PI*2;
    const spd=60+rng()*180;
    const sz=3+rng()*6;
    particles.push({
      x,y,
      vx:Math.cos(ang)*spd*(isGold?1.3:1),
      vy:Math.sin(ang)*spd*(isGold?1.3:1)-40,
      size:sz,color,alpha:1,
      life:0.5+rng()*0.6,age:0,
      gravity:300+rng()*200
    });
    if(isGold && i%2===0){
      // extra spark
      particles.push({
        x:x+rng()*10-5,y:y+rng()*10-5,
        vx:Math.cos(ang)*spd*0.5,
        vy:Math.sin(ang)*spd*0.5-80,
        size:2+rng()*3,color:'#fff',alpha:1,
        life:0.3+rng()*0.3,age:0,
        gravity:200
      });
    }
  }
}

function emitFloatingText(x,y,text,color){
  floatingTexts.push({x,y,text,color,alpha:1,age:0,life:0.9,vy:-60});
}

/* ── Shake ── */
function triggerShake(mag){shakeMag=Math.max(shakeMag,mag)}

/* ── Input handling ── */
function handleInput(){
  if(state==='start'){
    startGame();return;
  }
  if(state==='gameover'){
    if(elapsed>0.5) startGame();
    return;
  }
  inputQueued=true;
}

cvs.addEventListener('pointerdown',e=>{e.preventDefault();handleInput()});
document.addEventListener('keydown',e=>{
  if(e.code==='Space'||e.code==='Enter'){e.preventDefault();handleInput()}
});

/* ── Slam logic ── */
function processSlam(){
  const side=hammerSide;
  const lx=side===0?LANE_L:LANE_R;

  // Find nearest block on this side within reasonable range
  let best=null, bestDist=Infinity;
  for(const b of blocks){
    if(b.side!==side) continue;
    const dist=Math.abs(b.x-lx);
    if(dist<bestDist){bestDist=dist;best=b}
  }

  if(!best){
    // No blocks on this side: miss
    combo=0;multiplier=1;
    emitFloatingText(lx,RING_Y-40,'MISS','#ff4444');
    return;
  }

  const dist=Math.abs(best.x-best.laneX);
  if(dist<=timingWindow){
    // HIT
    best.hp--;
    if(best.hp<=0){
      // Destroy
      const isGold=best.type===BT.GOLD;
      const isTight=dist<=timingWindow*0.4;
      let pts=10;
      if(isTight) pts=25;
      if(isGold) pts=50;
      if(best.type===BT.FREEZE){
        freezeTimer=4;
        emitFloatingText(lx,RING_Y-50,'FREEZE!','#00e5ff');
      }
      combo++;
      if(combo>maxCombo) maxCombo=combo;
      multiplier=1+Math.floor(combo/5)*0.5;
      const gained=Math.round(pts*multiplier);
      score+=gained;
      emitParticles(best.x,best.y,BT_COLORS[best.type]||'#ff6fd8',isGold?25:14,isGold);
      const label=isTight?'PERFECT':'GOOD';
      emitFloatingText(lx,RING_Y-40,`${label} +${gained}`,isGold?'#ffd700':'#6eff6e');
      triggerShake(isTight?4:2);
      blocks.splice(blocks.indexOf(best),1);
    } else {
      // Shield cracked
      best.cracked=true;
      emitParticles(best.x,best.y,'#7b8cff',6,false);
      emitFloatingText(lx,RING_Y-40,'CRACK!','#7b8cff');
      triggerShake(2);
    }
  } else {
    // MISS - check near-miss
    const nearThresh=timingWindow*2;
    if(dist<=nearThresh){
      // Near miss
      slowMoTimer=0.2;
      const label=best.x < best.laneX ? (side===0?'EARLY':'LATE') : (side===0?'LATE':'EARLY');
      emitFloatingText(lx,RING_Y-40,label,'#ff8844');
    } else {
      emitFloatingText(lx,RING_Y-40,'MISS','#ff4444');
    }
    combo=0;multiplier=1;
  }
}

/* ── Start / Reset ── */
function startGame(){
  if(seededRng && challengeCode) seededRng=mulberry32(hashSeed(challengeCode));
  state='playing';
  score=0;combo=0;maxCombo=0;multiplier=1;
  elapsed=0;beatTimer=0;beatIndex=0;
  hammerSide=0;hammerAngle=0;hammerTargetAngle=0;
  blocks=[];particles=[];floatingTexts=[];
  shakeX=0;shakeY=0;shakeMag=0;
  slowMoTimer=0;slowMoFactor=1;freezeTimer=0;
  beatPulse=0;spawnAccum=0;gameOverFlash=0;
  hueShift=0;inputQueued=false;
  updateDifficulty();
}

function gameOver(){
  state='gameover';
  elapsed=0;
  gameOverFlash=1;
  triggerShake(12);
  if(score>bestScore){
    bestScore=score;
    localStorage.setItem('bb_best',bestScore);
  }
}

/* ── Share ── */
function shareScore(){
  const url=`${location.origin}${location.pathname}`;
  const text=`I scored ${score} in Beat Breaker! Can you beat me? ${url}?challenge=${btoa(String(score+Date.now())).slice(0,8)}`;
  if(navigator.share){
    navigator.share({title:'Beat Breaker',text,url}).catch(()=>{});
  } else {
    navigator.clipboard.writeText(text).then(()=>{
      emitFloatingText(W/2,H/2,'Copied!','#6eff6e');
    }).catch(()=>{});
  }
}

/* ── Update ── */
function update(dt){
  hueShift+=dt*15;
  if(state!=='playing') return;

  // Slow-mo
  if(slowMoTimer>0){
    slowMoTimer-=dt;
    slowMoFactor=0.3;
  } else {
    slowMoFactor=1;
  }
  const adt=dt*slowMoFactor;

  elapsed+=adt;
  if(freezeTimer>0) freezeTimer-=adt;
  updateDifficulty();

  // Beat timer
  beatTimer+=adt;
  beatPulse=Math.max(0,beatPulse-dt*4);
  if(beatTimer>=beatInterval){
    beatTimer-=beatInterval;
    beatIndex++;
    hammerSide=beatIndex%2;
    hammerTargetAngle=hammerSide===0?-0.4:0.4;
    beatPulse=1;
  }

  // Hammer animation
  hammerAngle+=(hammerTargetAngle-hammerAngle)*Math.min(1,dt*12);

  // Process input
  if(inputQueued){
    inputQueued=false;
    processSlam();
  }

  // Spawn blocks
  generateSpawns(adt);

  // Update blocks
  for(let i=blocks.length-1;i>=0;i--){
    const b=blocks[i];
    // Move toward lane center, then toward wall
    const targetX=b.laneX;
    const dx=targetX-b.x;
    const moveDir=dx>0?1:-1;
    const atLane=Math.abs(dx)<2;

    if(!atLane){
      b.x+=moveDir*approachSpeed*adt;
      // Clamp to lane if overshot
      if((moveDir>0&&b.x>targetX)||(moveDir<0&&b.x<targetX)) b.x=targetX;
    } else {
      // At ring, now push toward wall
      const wallX=b.side===0?WALL_L:WALL_R;
      const wallDir=b.side===0?-1:1;
      b.x+=wallDir*approachSpeed*0.5*adt;
      // Check wall collision
      if((b.side===0&&b.x<=wallX)||(b.side===1&&b.x>=wallX)){
        // Game over
        emitParticles(b.x,b.y,'#ff2222',20,false);
        gameOver();
        return;
      }
    }

    if(b.type===BT.GOLD) b.goldPulse+=adt*6;
  }

  // Update particles
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.age+=dt;
    if(p.age>=p.life){particles.splice(i,1);continue}
    p.x+=p.vx*dt;
    p.y+=p.vy*dt;
    p.vy+=p.gravity*dt;
    p.alpha=1-(p.age/p.life);
  }

  // Update floating texts
  for(let i=floatingTexts.length-1;i>=0;i--){
    const f=floatingTexts[i];
    f.age+=dt;
    if(f.age>=f.life){floatingTexts.splice(i,1);continue}
    f.y+=f.vy*dt;
    f.alpha=1-(f.age/f.life);
  }

  // Shake decay
  if(shakeMag>0){
    shakeX=(Math.random()-0.5)*shakeMag*2;
    shakeY=(Math.random()-0.5)*shakeMag*2;
    shakeMag*=Math.pow(0.05,dt);
    if(shakeMag<0.3) shakeMag=0;
  } else {
    shakeX=0;shakeY=0;
  }
}

/* ── Draw helpers ── */
function drawRoundRect(x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();
}

/* ── Render ── */
function render(){
  ctx.save();
  ctx.clearRect(0,0,W,H);

  // Background
  const bgGrad=ctx.createLinearGradient(0,0,0,H);
  bgGrad.addColorStop(0,'#0a0a1a');
  bgGrad.addColorStop(0.5,'#111130');
  bgGrad.addColorStop(1,'#0d0d24');
  ctx.fillStyle=bgGrad;
  ctx.fillRect(0,0,W,H);

  // Beat pulse glow
  if(beatPulse>0){
    const grd=ctx.createRadialGradient(CX,CY,0,CX,CY,200);
    grd.addColorStop(0,`hsla(${260+hueShift%360},80%,60%,${beatPulse*0.12})`);
    grd.addColorStop(1,'transparent');
    ctx.fillStyle=grd;
    ctx.fillRect(0,0,W,H);
  }

  // Apply shake
  ctx.translate(shakeX,shakeY);

  // Game over flash
  if(gameOverFlash>0 && state==='gameover'){
    ctx.fillStyle=`rgba(255,30,30,${gameOverFlash*0.3})`;
    ctx.fillRect(0,0,W,H);
    gameOverFlash=Math.max(0,gameOverFlash-0.02);
  }

  // Slow-mo flash
  if(slowMoTimer>0 && state==='playing'){
    const side=hammerSide;
    const lx=side===0?LANE_L:LANE_R;
    ctx.fillStyle=`rgba(255,60,30,${0.08})`;
    ctx.fillRect(side===0?0:W/2,0,W/2,H);
  }

  if(state==='start'){
    drawStartScreen();
  } else if(state==='playing'){
    drawGame();
  } else if(state==='gameover'){
    drawGame();
    drawGameOver();
  }

  ctx.restore();
}

function drawGame(){
  // Lane lines
  ctx.strokeStyle='rgba(255,255,255,0.06)';
  ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(W/2,0);ctx.lineTo(W/2,H);ctx.stroke();

  // Walls
  ctx.strokeStyle='rgba(255,80,80,0.3)';
  ctx.lineWidth=2;
  ctx.beginPath();ctx.moveTo(WALL_L,RING_Y-50);ctx.lineTo(WALL_L,RING_Y+50);ctx.stroke();
  ctx.beginPath();ctx.moveTo(WALL_R,RING_Y-50);ctx.lineTo(WALL_R,RING_Y+50);ctx.stroke();

  // Hit rings
  drawRing(LANE_L,RING_Y,0);
  drawRing(LANE_R,RING_Y,1);

  // Blocks
  for(const b of blocks){
    drawBlock(b);
  }

  // Hammer
  drawHammer();

  // Particles
  for(const p of particles){
    ctx.globalAlpha=p.alpha;
    ctx.fillStyle=p.color;
    ctx.fillRect(p.x-p.size/2,p.y-p.size/2,p.size,p.size);
  }
  ctx.globalAlpha=1;

  // Floating texts
  for(const f of floatingTexts){
    ctx.globalAlpha=f.alpha;
    ctx.fillStyle=f.color;
    ctx.font='bold 14px "Segoe UI",system-ui,sans-serif';
    ctx.textAlign='center';
    ctx.fillText(f.text,f.x,f.y);
  }
  ctx.globalAlpha=1;

  // HUD
  drawHUD();
}

function drawRing(x,y,side){
  const pulseR=RING_R+beatPulse*8;
  const active=hammerSide===side;
  const hue=active?(140+hueShift%360):(260+hueShift%360);

  // Outer ring
  ctx.beginPath();
  ctx.arc(x,y,pulseR,0,Math.PI*2);
  ctx.strokeStyle=`hsla(${hue},70%,60%,${active?0.5:0.2})`;
  ctx.lineWidth=active?3:1.5;
  ctx.stroke();

  // Timing window ring
  ctx.beginPath();
  ctx.arc(x,y,timingWindow,0,Math.PI*2);
  ctx.strokeStyle=`hsla(${hue},60%,50%,${active?0.3:0.1})`;
  ctx.lineWidth=1;
  ctx.setLineDash([4,4]);
  ctx.stroke();
  ctx.setLineDash([]);

  // Center dot
  ctx.beginPath();
  ctx.arc(x,y,3,0,Math.PI*2);
  ctx.fillStyle=`hsla(${hue},70%,70%,0.5)`;
  ctx.fill();
}

function drawBlock(b){
  const sz=b.size;
  const hx=b.x-sz/2, hy=b.y-sz/2;

  // Shadow
  ctx.fillStyle='rgba(0,0,0,0.3)';
  drawRoundRect(hx+2,hy+2,sz,sz,4);ctx.fill();

  // Body
  let color=BT_COLORS[b.type];
  if(b.type===BT.GOLD){
    const glow=Math.sin(b.goldPulse)*0.3+0.7;
    ctx.fillStyle=`rgba(255,215,0,${glow})`;
  } else {
    ctx.fillStyle=color;
  }
  drawRoundRect(hx,hy,sz,sz,4);ctx.fill();

  // Cracked overlay
  if(b.cracked){
    ctx.strokeStyle='rgba(255,255,255,0.7)';
    ctx.lineWidth=1.5;
    ctx.beginPath();
    ctx.moveTo(b.x-5,b.y-8);ctx.lineTo(b.x+2,b.y);ctx.lineTo(b.x-3,b.y+7);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(b.x+4,b.y-6);ctx.lineTo(b.x-1,b.y+2);ctx.lineTo(b.x+5,b.y+8);
    ctx.stroke();
  }

  // Type indicator
  if(b.type===BT.SHIELD && !b.cracked){
    ctx.strokeStyle='rgba(255,255,255,0.4)';
    ctx.lineWidth=2;
    ctx.beginPath();ctx.arc(b.x,b.y,sz/2-2,0,Math.PI*2);ctx.stroke();
  }
  if(b.type===BT.FREEZE){
    ctx.fillStyle='rgba(255,255,255,0.6)';
    ctx.font='bold 11px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('*',b.x,b.y+1);
  }
  if(b.type===BT.GOLD){
    ctx.fillStyle='rgba(100,60,0,0.7)';
    ctx.font='bold 10px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('$',b.x,b.y+1);
  }
}

function drawHammer(){
  const cx=CX, cy=CY;
  const len=50+combo*0.3;
  const headW=18+Math.min(combo*0.5,10);
  const headH=12;

  ctx.save();
  ctx.translate(cx,cy);
  ctx.rotate(hammerAngle);

  // Trail / smear (combo heat)
  if(combo>=5){
    const trailAlpha=Math.min(combo*0.02,0.35);
    const trailHue=(30+hueShift)%360;
    for(let i=1;i<=3;i++){
      ctx.globalAlpha=trailAlpha/i;
      ctx.fillStyle=`hsl(${trailHue},90%,60%)`;
      drawRoundRect(-4-i*2,-len+i*3,8+i*4,len-10,3);ctx.fill();
    }
    ctx.globalAlpha=1;
  }

  // Handle
  const handleGrad=ctx.createLinearGradient(0,0,0,-len);
  handleGrad.addColorStop(0,'#888');
  handleGrad.addColorStop(1,'#bbb');
  ctx.fillStyle=handleGrad;
  drawRoundRect(-4,0,8,-len+5,2);ctx.fill();

  // Head
  const heatHue=combo>=3?`hsl(${(0+combo*8+hueShift)%360},80%,55%)`:'#ddd';
  ctx.fillStyle=heatHue;
  drawRoundRect(-headW/2,-len-headH/2,headW,headH,3);ctx.fill();

  // Head shine
  ctx.fillStyle='rgba(255,255,255,0.3)';
  drawRoundRect(-headW/2+2,-len-headH/2+2,headW-4,headH/2-1,2);ctx.fill();

  ctx.restore();
}

function drawHUD(){
  // Score
  ctx.fillStyle='#fff';
  ctx.font='bold 22px "Segoe UI",system-ui,sans-serif';
  ctx.textAlign='center';
  ctx.fillText(score,CX,30);

  // Combo
  if(combo>=2){
    const comboHue=(180+hueShift)%360;
    ctx.fillStyle=`hsl(${comboHue},80%,65%)`;
    ctx.font='bold 13px "Segoe UI",system-ui,sans-serif';
    ctx.fillText(`${combo}x COMBO (×${multiplier.toFixed(1)})`,CX,50);
  }

  // Freeze indicator
  if(freezeTimer>0){
    ctx.fillStyle='#00e5ff';
    ctx.font='bold 11px sans-serif';
    ctx.fillText(`FREEZE ${freezeTimer.toFixed(1)}s`,CX,66);
  }

  // Side indicators
  ctx.font='bold 11px sans-serif';
  ctx.fillStyle=hammerSide===0?'rgba(150,255,150,0.7)':'rgba(255,255,255,0.2)';
  ctx.textAlign='center';
  ctx.fillText('L',LANE_L,H-20);
  ctx.fillStyle=hammerSide===1?'rgba(150,255,150,0.7)':'rgba(255,255,255,0.2)';
  ctx.fillText('R',LANE_R,H-20);
}

function drawStartScreen(){
  // Title
  ctx.fillStyle='#fff';
  ctx.font='bold 36px "Segoe UI",system-ui,sans-serif';
  ctx.textAlign='center';
  ctx.fillText('BEAT',CX,CY-80);

  const titleHue=(hueShift*3)%360;
  ctx.fillStyle=`hsl(${titleHue},80%,65%)`;
  ctx.font='bold 42px "Segoe UI",system-ui,sans-serif';
  ctx.fillText('BREAKER',CX,CY-35);

  // Subtitle
  ctx.fillStyle='rgba(255,255,255,0.5)';
  ctx.font='14px sans-serif';
  ctx.fillText('Split Hammer',CX,CY);

  // Instructions
  ctx.fillStyle='rgba(255,255,255,0.6)';
  ctx.font='13px sans-serif';
  ctx.fillText('Tap / Space / Enter to slam',CX,CY+50);
  ctx.fillText('Break blocks in rhythm!',CX,CY+70);

  // Pulse prompt
  const pulse=Math.sin(Date.now()/400)*0.3+0.7;
  ctx.globalAlpha=pulse;
  ctx.fillStyle='#ff6fd8';
  ctx.font='bold 16px sans-serif';
  ctx.fillText('TAP TO START',CX,CY+120);
  ctx.globalAlpha=1;

  // Best score
  if(bestScore>0){
    ctx.fillStyle='rgba(255,255,255,0.4)';
    ctx.font='12px sans-serif';
    ctx.fillText(`Best: ${bestScore}`,CX,CY+155);
  }

  // Challenge
  if(challengeCode){
    ctx.fillStyle='#ffd700';
    ctx.font='bold 12px sans-serif';
    ctx.fillText(`Challenge: ${challengeCode}`,CX,CY+180);
  }

  // Draw decorative rings
  drawRing(LANE_L,RING_Y,0);
  drawRing(LANE_R,RING_Y,1);
}

function drawGameOver(){
  // Overlay
  ctx.fillStyle='rgba(0,0,0,0.6)';
  ctx.fillRect(0,0,W,H);

  ctx.fillStyle='#ff4444';
  ctx.font='bold 32px "Segoe UI",system-ui,sans-serif';
  ctx.textAlign='center';
  ctx.fillText('GAME OVER',CX,CY-80);

  ctx.fillStyle='#fff';
  ctx.font='bold 24px sans-serif';
  ctx.fillText(`Score: ${score}`,CX,CY-35);

  ctx.fillStyle='rgba(255,255,255,0.5)';
  ctx.font='14px sans-serif';
  ctx.fillText(`Max Combo: ${maxCombo}`,CX,CY-5);

  if(score>=bestScore && score>0){
    ctx.fillStyle='#ffd700';
    ctx.font='bold 14px sans-serif';
    ctx.fillText('NEW BEST!',CX,CY+25);
  } else {
    ctx.fillStyle='rgba(255,255,255,0.4)';
    ctx.font='12px sans-serif';
    ctx.fillText(`Best: ${bestScore}`,CX,CY+25);
  }

  // Share button
  const btnW=140, btnH=36;
  const btnX=CX-btnW/2, btnY=CY+50;
  ctx.fillStyle='#7b68ee';
  drawRoundRect(btnX,btnY,btnW,btnH,8);ctx.fill();
  ctx.fillStyle='#fff';
  ctx.font='bold 13px sans-serif';
  ctx.fillText('Share Score',CX,btnY+23);

  // Store button area for click detection
  drawGameOver._shareBtnRect={x:btnX,y:btnY,w:btnW,h:btnH};

  // Restart
  const pulse=Math.sin(Date.now()/400)*0.3+0.7;
  ctx.globalAlpha=pulse;
  ctx.fillStyle='rgba(255,255,255,0.6)';
  ctx.font='14px sans-serif';
  ctx.fillText('Tap to restart',CX,CY+120);
  ctx.globalAlpha=1;
}

// Share button click handler
cvs.addEventListener('pointerdown',e=>{
  if(state!=='gameover') return;
  const rect=cvs.getBoundingClientRect();
  const scaleX=W/rect.width;
  const scaleY=H/rect.height;
  const mx=(e.clientX-rect.left)*scaleX;
  const my=(e.clientY-rect.top)*scaleY;
  const btn=drawGameOver._shareBtnRect;
  if(btn && mx>=btn.x && mx<=btn.x+btn.w && my>=btn.y && my<=btn.y+btn.h){
    e.stopPropagation();
    shareScore();
  }
});

/* ── Main loop ── */
function loop(ts){
  requestAnimationFrame(loop);
  if(!lastTime) lastTime=ts;
  let dt=(ts-lastTime)/1000;
  lastTime=ts;

  // Clamp dt for stability
  if(dt>0.1) dt=0.1;
  if(dt<=0) return;

  update(dt);
  render();
}

requestAnimationFrame(loop);

})();
</script>
</body>
</html>
