<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authenticating... - TheRobots.io</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
        }
        .container {
            text-align: center;
            padding: 2rem;
            max-width: 400px;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .message { font-size: 1.2rem; opacity: 0.9; }
        .error { color: #ff6b6b; margin-top: 1rem; word-break: break-word; }
        .debug { font-size: 0.8rem; opacity: 0.6; margin-top: 1rem; word-break: break-all; }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner" id="spinner"></div>
        <p class="message" id="message">Completing authentication...</p>
        <p id="error" class="error" style="display: none;"></p>
        <p id="debug" class="debug" style="display: none;"></p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://api.srv936332.hstgr.cloud';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE';

        // Decode JWT payload to get user info without calling setSession
        function decodeJwtPayload(token) {
            try {
                const parts = token.split('.');
                if (parts.length !== 3) return null;
                const payload = JSON.parse(atob(parts[1]));
                return payload;
            } catch (e) {
                console.error('Failed to decode JWT:', e);
                return null;
            }
        }

        async function init() {
            try {
                // Get stored auth context
                const app = localStorage.getItem('oauth_app');
                const returnUrl = localStorage.getItem('oauth_return_url');

                // Parse tokens from URL hash (Supabase puts them there after OAuth)
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const accessToken = hashParams.get('access_token');
                const refreshToken = hashParams.get('refresh_token');

                // Debug info
                console.log('App:', app);
                console.log('Return URL:', returnUrl);
                console.log('Has access token:', !!accessToken);
                console.log('Has refresh token:', !!refreshToken);

                if (!accessToken) {
                    showError('No authentication token found. Please try signing in again.');
                    return;
                }

                if (!app || !returnUrl) {
                    showError('Missing app context. Please start the sign-in process from your app.');
                    return;
                }

                // Decode JWT to get user info (don't call setSession - that must happen on the originating app)
                const payload = decodeJwtPayload(accessToken);
                if (!payload) {
                    showError('Failed to decode authentication token.');
                    return;
                }

                const userId = payload.sub;
                const email = payload.email;

                console.log('User ID from JWT:', userId);
                console.log('Email from JWT:', email);

                // Track login in user_tracking table
                if (app && userId) {
                    updateMessage('Tracking login...');
                    await trackUserLogin(userId, email, app);
                }

                // Clean up localStorage
                localStorage.removeItem('oauth_app');
                localStorage.removeItem('oauth_return_url');

                // Redirect to originating app with tokens
                // The originating app will call setSession() with these tokens
                updateMessage('Redirecting back to app...');

                const redirectUrl = new URL(returnUrl);
                redirectUrl.searchParams.set('access_token', accessToken);
                redirectUrl.searchParams.set('refresh_token', refreshToken);

                window.location.href = redirectUrl.toString();

            } catch (e) {
                showError('Unexpected error: ' + e.message);
                console.error(e);
            }
        }

        async function trackUserLogin(userId, email, appName) {
            try {
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                // Check if user exists for this app
                const { data: existing, error: fetchError } = await supabase
                    .from('user_tracking')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('app', appName)
                    .maybeSingle();

                if (fetchError) {
                    console.error('Error checking existing user:', fetchError);
                    return;
                }

                if (existing) {
                    // Update login count and last login
                    const { error: updateError } = await supabase
                        .from('user_tracking')
                        .update({
                            login_cnt: existing.login_cnt + 1,
                            last_login_ts: new Date().toISOString()
                        })
                        .eq('user_id', userId)
                        .eq('app', appName);
                    if (updateError) console.error('Error updating user tracking:', updateError);
                    else console.log('Updated user tracking for', appName);
                } else {
                    // Insert new record
                    const { error: insertError } = await supabase
                        .from('user_tracking')
                        .insert({
                            user_id: userId,
                            email: email,
                            app: appName
                        });
                    if (insertError) console.error('Error inserting user tracking:', insertError);
                    else console.log('Inserted user tracking for', appName);
                }
            } catch (e) {
                console.error('Error tracking user login:', e);
            }
        }

        function updateMessage(msg) {
            document.getElementById('message').textContent = msg;
        }

        function showError(msg) {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('message').textContent = 'Authentication Failed';
            const errorEl = document.getElementById('error');
            errorEl.textContent = msg;
            errorEl.style.display = 'block';

            // Show debug info
            const debugEl = document.getElementById('debug');
            debugEl.innerHTML = `
                Hash: ${window.location.hash ? 'present' : 'empty'}<br>
                App: ${localStorage.getItem('oauth_app') || 'not set'}<br>
                Return URL: ${localStorage.getItem('oauth_return_url') || 'not set'}
            `;
            debugEl.style.display = 'block';
        }

        init();
    </script>
</body>
</html>
